{% block content %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Workout Calendar</h5>
    <div id="calendar-container">
      <div id="calendar"></div>
    </div>
    <button class="btn btn-outline-primary mt-3" id="expand-calendar">
      Enlarge
    </button>
  </div>
</div>

<!-- Add/Edit Workout Modal -->
<div
  class="modal fade"
  id="addWorkoutModal"
  tabindex="-1"
  aria-labelledby="addWorkoutModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addWorkoutForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addWorkoutModalLabel">Workout</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="workoutId" name="id" />
          <div class="mb-3">
            <label for="workoutTitle" class="form-label">Workout Name</label>
            <input
              type="text"
              class="form-control"
              id="workoutTitle"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="workoutDescription" class="form-label"
              >Description</label
            >
            <input
              type="text"
              class="form-control"
              id="workoutDescription"
              name="description"
            />
          </div>
          <div class="mb-3">
            <label for="workoutClient" class="form-label"
              >Assign to Client</label
            >
            <select
              class="form-select"
              id="workoutClient"
              name="client_id"
              required
            >
              <option value="">Select client</option>
            </select>
          </div>
          <input type="hidden" id="workoutStart" name="start" />
          <input type="hidden" id="workoutEnd" name="end" />
          <input type="hidden" id="workoutDate" name="date" />
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-danger me-auto"
            id="deleteWorkoutBtn"
            style="display:none;"
          >
            Delete
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Workout</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      selectable: true,
      editable: true,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay",
      },
      dateClick: function (info) {
        calendar.changeView("timeGridDay", info.dateStr);
      },
      select: function (info) {
        // Clear form for new workout
        document.getElementById("addWorkoutForm").reset();
        document.getElementById("workoutId").value = "";
        document.getElementById("workoutStart").value = info.startStr;
        document.getElementById("workoutEnd").value = info.endStr;
        document.getElementById("workoutDate").value = info.startStr.split("T")[0];
        document.getElementById("deleteWorkoutBtn").style.display = "none";
        var addWorkoutModal = new bootstrap.Modal(document.getElementById("addWorkoutModal"));
        addWorkoutModal.show();
      },
      eventClick: function(info) {
        // Fill form with event data for editing
        const event = info.event;
        document.getElementById("workoutId").value = event.id;
        document.getElementById("workoutTitle").value = event.title;
        document.getElementById("workoutDescription").value = event.extendedProps.description || "";
        document.getElementById("workoutClient").value = event.extendedProps.client_id || "";
        document.getElementById("workoutStart").value = event.startStr;
        document.getElementById("workoutEnd").value = event.endStr;
        document.getElementById("workoutDate").value = event.startStr.split("T")[0];
        document.getElementById("deleteWorkoutBtn").style.display = "";
        var addWorkoutModal = new bootstrap.Modal(document.getElementById("addWorkoutModal"));
        addWorkoutModal.show();
      },
      events: "/get_workouts",
    });

    calendar.render();

    // Populate client dropdown
    document
      .getElementById("addWorkoutModal")
      .addEventListener("show.bs.modal", () => {
        fetch("/clients?json=1")
          .then((res) => res.json())
          .then((clients) => {
            const select = document.getElementById("workoutClient");
            select.innerHTML = '<option value="">Select client</option>'; // reset
            clients.forEach((client) => {
              const opt = document.createElement("option");
              opt.value = client.id;
              opt.textContent = client.name;
              select.appendChild(opt);
            });
          })
          .catch((err) => console.error("Error loading clients:", err));
      });

    // Handle form submission (add or edit)
    document
      .getElementById("addWorkoutForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const workoutId = form.id.value;
        const url = workoutId ? `/edit_workout/${workoutId}` : "/add_workout";
        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: form.title.value,
            description: form.description.value,
            start: form.start.value,
            end: form.end.value,
            date: form.date.value,
            client_id: form.client_id.value,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              calendar.refetchEvents();
              bootstrap.Modal.getInstance(
                document.getElementById("addWorkoutModal")
              ).hide();
            } else {
              alert("Failed to save workout.");
            }
          });
      });

    // Handle delete
    document.getElementById("deleteWorkoutBtn").addEventListener("click", function () {
      const workoutId = document.getElementById("workoutId").value;
      if (workoutId && confirm("Are you sure you want to delete this workout?")) {
        fetch(`/delete_workout/${workoutId}`, { method: "POST" })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              calendar.refetchEvents();
              bootstrap.Modal.getInstance(
                document.getElementById("addWorkoutModal")
              ).hide();
            } else {
              alert("Failed to delete workout.");
            }
          });
      }
    });

    // Enlarge / Shrink calendar
    const btn = document.getElementById("expand-calendar");
    btn.addEventListener("click", () => {
      const container = document.getElementById("calendar-container");
      container.classList.toggle("fullscreen-calendar");
      calendar.updateSize();
      btn.textContent = container.classList.contains("fullscreen-calendar")
        ? "Shrink"
        : "Enlarge";
    });
  });
</script>

{% endblock %}
